// js/cadastros.js

// IMPORTS DO FIREBASE (SDK MODULAR VIA CDN)
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getAuth, 
  onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { 
  getFirestore, 
  collection, 
  addDoc, 
  getDocs, 
  doc, 
  getDoc, 
  query, 
  orderBy 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// 游댢 COLE AQUI O MESMO firebaseConfig QUE VOC칅 USA NO login.js / reservas.js
const firebaseConfig = {
  // apiKey: "...",
  // authDomain: "...",
  // projectId: "...",
  // ...
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

// ELEMENTOS DA TELA
const formUsuario   = document.getElementById('formUsuario');
const formTurma     = document.getElementById('formTurma');
const tbodyUsuarios = document.getElementById('tbodyUsuarios');
const tbodyTurmas   = document.getElementById('tbodyTurmas');

// GARANTE QUE S칍 ADMIN ENTRA NESSA TELA
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    alert('Voc칡 precisa estar logado para acessar os cadastros.');
    window.location.href = 'login.html';
    return;
  }

  try {
    const refUsuario = doc(db, 'usuarios', user.uid);
    const snapUsuario = await getDoc(refUsuario);

    if (!snapUsuario.exists()) {
      alert('Seu usu치rio n칚o possui perfil definido. Fale com o administrador.');
      window.location.href = 'reservas.html';
      return;
    }

    const dados = snapUsuario.data();
    // 丘멆잺 AQUI EU ASSUMO QUE VOC칅 TEM UM CAMPO "tipo" = "admin" | "professor"
    if (dados.tipo !== 'admin') {
      alert('Apenas administradores podem acessar esta 치rea.');
      window.location.href = 'reservas.html';
      return;
    }

    // SE CHEGOU AQUI, 칄 ADMIN 游녨
    inicializarCadastros();

  } catch (err) {
    console.error('Erro ao verificar perfil de usu치rio:', err);
    alert('Erro ao verificar permiss칫es. Tente novamente.');
    window.location.href = 'login.html';
  }
});

// INICIALIZA EVENTOS E CARREGA LISTAS
function inicializarCadastros() {
  if (formUsuario) {
    formUsuario.addEventListener('submit', async (e) => {
      e.preventDefault();
      await salvarUsuario();
    });
  }

  if (formTurma) {
    formTurma.addEventListener('submit', async (e) => {
      e.preventDefault();
      await salvarTurma();
    });
  }

  carregarUsuarios();
  carregarTurmas();
}

// --- USU츼RIOS ---

async function salvarUsuario() {
  const nome  = document.getElementById('nomeUsuario').value.trim();
  const email = document.getElementById('emailUsuario').value.trim();
  const tipo  = document.getElementById('tipoUsuario').value;
  const turma = document.getElementById('turmaUsuario').value.trim();

  if (!nome || !email || !tipo || !turma) {
    alert('Preencha todos os campos do usu치rio.');
    return;
  }

  try {
    await addDoc(collection(db, 'usuarios'), {
      nome,
      email,
      tipo,
      turma,
      criadoEm: new Date()
    });

    alert('Usu치rio salvo com sucesso!');
    formUsuario.reset();
    carregarUsuarios();

  } catch (err) {
    console.error('Erro ao salvar usu치rio:', err);
    alert('Erro ao salvar usu치rio. Veja o console para detalhes.');
  }
}

async function carregarUsuarios() {
  tbodyUsuarios.innerHTML = '<tr><td colspan="4">Carregando...</td></tr>';

  try {
    const q = query(collection(db, 'usuarios'), orderBy('nome'));
    const snap = await getDocs(q);

    if (snap.empty) {
      tbodyUsuarios.innerHTML = '<tr><td colspan="4">Nenhum usu치rio cadastrado.</td></tr>';
      return;
    }

    let html = '';
    snap.forEach(docSnap => {
      const u = docSnap.data();
      html += `
        <tr>
          <td>${u.nome || ''}</td>
          <td>${u.email || ''}</td>
          <td>${u.tipo || ''}</td>
          <td>${u.turma || ''}</td>
        </tr>
      `;
    });

    tbodyUsuarios.innerHTML = html;

  } catch (err) {
    console.error('Erro ao carregar usu치rios:', err);
    tbodyUsuarios.innerHTML = '<tr><td colspan="4">Erro ao carregar usu치rios.</td></tr>';
  }
}

// --- TURMAS ---

async function salvarTurma() {
  const nome  = document.getElementById('nomeTurma').value.trim();
  const serie = document.getElementById('serieTurma').value.trim();
  const turno = document.getElementById('turnoTurma').value;

  if (!nome || !serie || !turno) {
    alert('Preencha todos os campos da turma.');
    return;
  }

  try {
    await addDoc(collection(db, 'turmas'), {
      nome,
      serie,
      turno,
      criadoEm: new Date()
    });

    alert('Turma salva com sucesso!');
    formTurma.reset();
    carregarTurmas();

  } catch (err) {
    console.error('Erro ao salvar turma:', err);
    alert('Erro ao salvar turma. Veja o console para detalhes.');
  }
}

async function carregarTurmas() {
  tbodyTurmas.innerHTML = '<tr><td colspan="3">Carregando...</td></tr>';

  try {
    const q = query(collection(db, 'turmas'), orderBy('nome'));
    const snap = await getDocs(q);

    if (snap.empty) {
      tbodyTurmas.innerHTML = '<tr><td colspan="3">Nenhuma turma cadastrada.</td></tr>';
      return;
    }

    let html = '';
    snap.forEach(docSnap => {
      const t = docSnap.data();
      html += `
        <tr>
          <td>${t.nome || ''}</td>
          <td>${t.serie || ''}</td>
          <td>${t.turno || ''}</td>
        </tr>
      `;
    });

    tbodyTurmas.innerHTML = html;

  } catch (err) {
    console.error('Erro ao carregar turmas:', err);
    tbodyTurmas.innerHTML = '<tr><td colspan="3">Erro ao carregar turmas.</td></tr>';
  }
}
