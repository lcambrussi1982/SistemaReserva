<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Login • Colégio Estadual Padre Ponciano</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="./css/cambrussi.css">
</head>
<body>
  <header class="topo">
    <img src="./img/logo.png" alt="Logo do colégio" class="logo">
    <div>
      <h1>Colégio Estadual Padre Ponciano</h1>
      <p>Sistema desenvolvido pela Cambrussi Technologies • Dados sincronizados na nuvem (Firebase Firestore)</p>
    </div>
  </header>

  <nav class="menu">
    <a href="index.html">Início</a>
    <a href="reservas.html">Reservas</a>
    <a href="dispositivos.html">Dispositivos</a>
    <a href="cadastros.html">Cadastros</a>
    <a href="tutorial.html">Tutorial</a>
    <a href="login.html" class="ativo direita">Login</a>
  </nav>

  <main class="conteudo">
    <h2>Login</h2>
    <form id="formLogin" class="card">
      <div class="campo">
        <label for="email">E-mail</label>
        <input id="email" type="email" required>
      </div>
      <div class="campo">
        <label for="senha">Senha</label>
        <input id="senha" type="password" required>
      </div>
      <button type="submit">Entrar</button>
      <p id="msgErro" class="erro"></p>
    </form>
    <p class="dica">
      Nesta versão, o login procura um documento na coleção <code>usuarios</code> com os campos
      <code>email</code> e <code>senhaHash</code> iguais aos digitados. O campo <code>role</code> define se o usuário é
      ADMIN ou PROFESSOR.
    </p>
  </main>

  <footer class="rodape">
    © Colégio Estadual Padre Ponciano • Sistema desenvolvido pela Cambrussi Technologies
  </footer>

  <script type="module">
    import { db } from "./js/firebase-config.js";
    import {
      collection,
      query,
      where,
      getDocs
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    const form = document.getElementById("formLogin");
    const msgErro = document.getElementById("msgErro");

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      msgErro.textContent = "";

      const email = document.getElementById("email").value.trim();
      const senha = document.getElementById("senha").value.trim();

      if (!email || !senha) {
        msgErro.textContent = "Preencha e-mail e senha.";
        return;
      }

      try {
        const q = query(
          collection(db, "usuarios"),
          where("email", "==", email),
          where("senhaHash", "==", senha)
        );
        const snap = await getDocs(q);

        if (snap.empty) {
          msgErro.textContent = "Usuário ou senha inválidos.";
          return;
        }

        const doc = snap.docs[0];
        const data = doc.data();

        const usuario = {
          id: doc.id,
          nome: data.nome || "",
          email: data.email || email,
          role: data.role || "PROFESSOR"
        };
        localStorage.setItem("usuarioAtual", JSON.stringify(usuario));
        window.location.href = "reservas.html";
      } catch (e) {
        console.error(e);
        msgErro.textContent = "Erro ao fazer login. Veja o console.";
      }
    });
  </script>
</body>
</html>
